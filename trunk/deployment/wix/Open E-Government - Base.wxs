<?xml version="1.0" encoding="UTF-8"?>

<!-- $Id$ -->
<!-- Compiles fine with WiX 3.5 -->

<?define BasePath = "..\.." ?>
<?define LocalePath = "$(var.BasePath)\locale" ?>

<!-- Open E-Government: Base" -->
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">

  <?include $(sys.CURRENTDIR)Settings.wxi ?>

  <!-- An auto-generated Id attribute (changes each time we build the MSI) means "Major Upgrade". -->
  <Product Id="*"
    Name="!(loc.FullProductName)"
    Language="1033" Codepage="$(var.Codepage)" Version="$(var.VersionNumber)"
    Manufacturer="!(loc.ManufacturerName)" UpgradeCode="$(var.UpgradeCode)">

    <Package Id="*"
      Description="!(loc.FullProductName) $(var.VersionNumber)"
      Comments="This installer database contains the main package needed for every Open E-Government Application."
      Manufacturer="!(loc.ManufacturerName)"
      InstallerVersion="200"
      AdminImage="no"
      Keywords="Installer"
      ShortNames="no"
      Compressed="yes"
      Languages="1033"
      SummaryCodepage="$(var.Codepage)"
      Platform="$(var.ProcessorArchitecture)"
      ReadOnly="no" />

    <!-- This uninstalls all previous versions upon installing a version.     -->
    <!-- It's important that Upgrade/@Id matches Product/@UpgradeCode.        -->
    <!-- if you release a new build of the same version (Product/@Id changes, -->
    <!-- but Product/@Version doesn't), this uninstalls the old one.          -->
    <Upgrade Id="{94316AAA-90A9-11DF-8CB0-A15FDFD72085}">
      <UpgradeVersion Property="PREVIOUSFOUND"
        Minimum="0.0.0.0" IncludeMinimum="yes"
        Maximum="$(var.VersionNumber)" IncludeMaximum="no" />
    </Upgrade>
    <InstallExecuteSequence>
      <RemoveExistingProducts After="InstallInitialize" />
    </InstallExecuteSequence>

    <Property Id="HomePageURL" Value="http://www.open-egov.de/" />

    <?include ControlPanel.wxi ?>

    <WixVariable Id="WixUILicenseRtf" Value="$(var.License)" /> <!-- license.en.rtf -->
    <WixVariable Id="WixUIBannerBmp" Value="banner.bmp" />
    <WixVariable Id="WixUIDialogBmp" Value="dialog.bmp" />
    <!-- WixVariable Id="WixUIExclamationIco" Value="path\exclamation.ico" />
    <WixVariable Id="WixUIInfoIco" Value="path\information.ico" />
    <WixVariable Id="WixUINewIco" Value="path\new.ico" />
    <WixVariable Id="WixUIUpIco" Value="path\up.ico" / -->

    <Media Id="1" Cabinet="oegbase.cab" CompressionLevel="high" EmbedCab="yes" />
 
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder" Name="ProgramFilesDir">
        <!-- The public property INSTALLDIR may be changed on command line using: -->
        <!-- msiexec /i oeg-base.msi INSTALLDIR=C:\OEG -->
        <Directory Id="INSTALLDIR" ShortName="OpenEGov" Name="Open E-Government">
          <Component Id="BaseComponent" Guid="{B828569E-90A9-11DF-AEFA-0D60DFD72085}" KeyPath="yes"><!-- DiskId="1" -->
            <CreateFolder />
            <File Id="info.txt" Name="info.txt" ShortName="info.txt" DiskId="1" Source="../../info.txt" />
          </Component>

          <Directory Id="dir1" Name="bin">
            <!-- This GUID is checked for in other applications! -->
            <Component Id="BaseBinComponent" Guid="{4A217218-90BB-11DF-A10C-5774DFD72085}">
              <CreateFolder />
              <File Id="BinAboutDialog.exe" Source="$(var.BasePath)\bin\about-dialog.exe" />
              <File Source="$(var.BasePath)\bin\builder.exe" />
              <File Source="$(var.BasePath)\bin\bug-reporter.exe" />
              <File Source="$(var.BasePath)\bin\desktop.exe" KeyPath="yes" />
              <File Source="$(var.BasePath)\bin\explorer.exe" />
              <File Source="$(var.BasePath)\bin\file-manager.exe" />
              <File Source="$(var.BasePath)\bin\help-viewer.exe" />
              <File Source="$(var.BasePath)\bin\process-list.exe" />
              <File Source="$(var.BasePath)\bin\settings.exe" />

              <File Source="$(var.BasePath)\bin\libgcc_s_dw2-1.dll" />
              <File Source="$(var.BasePath)\bin\libiconv-2.dll" />
              <File Source="$(var.BasePath)\bin\libintl-8.dll" />
              <File Source="$(var.BasePath)\bin\libstdc++-6.dll" />
              <File Source="$(var.BasePath)\bin\mingwm10.dll" />
              <File Source="$(var.BasePath)\bin\oegCrypt1.dll" />
              <File Source="$(var.BasePath)\bin\oegMath1.dll" />
              <File Source="$(var.BasePath)\bin\oegQt1.dll" />
              <File Source="$(var.BasePath)\bin\phonon4.dll" DefaultLanguage="1033" Checksum="yes" />
              <File Source="$(var.BasePath)\bin\QtConcurrent.dll" />
              <File Source="$(var.BasePath)\bin\QtCore4.dll" Vital="yes" DefaultLanguage="1033" Checksum="yes" />
              <File Source="$(var.BasePath)\bin\QtGui4.dll" DefaultLanguage="1033" Checksum="yes" />
              <File Source="$(var.BasePath)\bin\QtHelp4.dll" DefaultLanguage="1033" Checksum="yes" />
              <File Source="$(var.BasePath)\bin\QtMultimedia4.dll" DefaultLanguage="1033" Checksum="yes" />
              <File Source="$(var.BasePath)\bin\QtNetwork4.dll" DefaultLanguage="1033" Checksum="yes" />
              <File Source="$(var.BasePath)\bin\QtOpenGL4.dll" DefaultLanguage="1033" Checksum="yes" />
              <File Source="$(var.BasePath)\bin\QtScript4.dll" DefaultLanguage="1033" Checksum="yes" />
              <File Source="$(var.BasePath)\bin\QtScriptTools4.dll" DefaultLanguage="1033" Checksum="yes" />
              <File Source="$(var.BasePath)\bin\QtSql4.dll" DefaultLanguage="1033" Checksum="yes" />
              <File Source="$(var.BasePath)\bin\QtSvg4.dll" DefaultLanguage="1033" Checksum="yes" />
              <File Source="$(var.BasePath)\bin\QtWebKit4.dll" DefaultLanguage="1033" Checksum="yes" />
              <File Source="$(var.BasePath)\bin\QtXml4.dll" DefaultLanguage="1033" Checksum="yes" />
              <File Source="$(var.BasePath)\bin\QtXmlPatterns4.dll" DefaultLanguage="1033" Checksum="yes" />
            </Component>
          </Directory>

          <Directory Id="dir2" Name="plugins">
            <Component Id="BasePluginsComponent" Guid="{D78E7348-90BC-11DF-AA7E-F775DFD72085}" KeyPath="yes">
              <CreateFolder />
            </Component>

            <Directory Id="dir3" Name="accessible">
              <Component Id="BasePluginsAccessibleComponent" Guid="{F7C22360-90BE-11DF-9BF0-9B78DFD72085}" KeyPath="yes">
                <CreateFolder />
              </Component>
            </Directory>

            <Directory Id="dir4" Name="codecs">
              <Component Id="BasePluginsCodecsComponent" Guid="{26A6345A-90BF-11DF-9801-E178DFD72085}" KeyPath="yes">
                <CreateFolder />
              </Component>
            </Directory>

            <Directory Id="dir5" Name="iconengines">
              <Component Id="BasePluginsIconEnginesComponent" Guid="{B05A9D3C-90BD-11DF-8E07-3477DFD72085}" KeyPath="yes">
                <CreateFolder />
                <File Source="$(var.BasePath)\plugins\qt\iconengines\qsvgicon4.dll" DefaultLanguage="1033" Checksum="yes" />
              </Component>
            </Directory>

            <Directory Id="dir6" Name="imageformats">
              <Component Id="BasePluginsImageFormatsComponent" Guid="{65C54694-90BF-11DF-AD9D-0E79DFD72085}" KeyPath="yes">
                <CreateFolder />
                <File Source="$(var.BasePath)\plugins\qt\imageformats\qgif4.dll"  DefaultLanguage="1033" Checksum="yes" />
                <File Source="$(var.BasePath)\plugins\qt\imageformats\qjpeg4.dll" DefaultLanguage="1033" Checksum="yes" />
                <File Source="$(var.BasePath)\plugins\qt\imageformats\qmng4.dll"  DefaultLanguage="1033" Checksum="yes" />
                <File Source="$(var.BasePath)\plugins\qt\imageformats\qsvg4.dll"  DefaultLanguage="1033" Checksum="yes" />
                <File Source="$(var.BasePath)\plugins\qt\imageformats\qtiff4.dll" DefaultLanguage="1033" Checksum="yes" />
              </Component>
            </Directory>

            <Directory Id="dir7" Name="sqldrivers">
              <Component Id="BasePluginsSqlDriversComponent" Guid="{6C0BF11A-90BF-11DF-9333-1579DFD72085}" KeyPath="yes">
                <CreateFolder />
                <File Source="$(var.BasePath)\plugins\qt\sqldrivers\qsqlite4.dll" DefaultLanguage="1033" Checksum="yes" />
              </Component>
            </Directory>
          </Directory><!-- end of plugins dir -->
        </Directory><!-- end of oeg main dir -->
      </Directory><!-- end of programm files dir -->

      <!-- start menu folders -->
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ProgramMenuProductFolder" Name="Open E-Government">
          <Directory Id="ProgramMenuProductExtrasFolder" Name="Extras" />
          <Directory Id="ProgramMenuProductDocumentationFolder" Name="Documentation" />
          <Directory Id="ProgramMenuProductComponentsFolder" Name="Components" />
        </Directory>
      </Directory>
    </Directory>

    <!-- Add shortcuts to the installer package -->
    <DirectoryRef Id="ProgramMenuProductFolder">
      <Component Id="StartMenuComponent" Guid="{D37F653E-8D13-4DDF-AF2C-8FE4896FC38F}">
        <!-- create folders -->
        <CreateFolder Directory="ProgramMenuProductFolder" />
        <CreateFolder Directory="ProgramMenuProductExtrasFolder" />
        <CreateFolder Directory="ProgramMenuProductDocumentationFolder" />
        <CreateFolder Directory="ProgramMenuProductComponentsFolder" />

        <!-- remove folders -->
        <RemoveFolder Id="RemoveProgramMenuProductFolder"
          Directory="ProgramMenuProductFolder" On="uninstall" />
        <RemoveFolder Id="RemoveProgramMenuProductExtrasFolder"
          Directory="ProgramMenuProductExtrasFolder" On="uninstall" />
        <RemoveFolder Id="RemoveProgramMenuProductDocumentationFolder"
          Directory="ProgramMenuProductDocumentationFolder" On="uninstall" />
        <RemoveFolder Id="RemoveProgramMenuProductComponentsFolder"
          Directory="ProgramMenuProductComponentsFolder" On="uninstall" />

        <!-- RegistryValue whichs serves as KeyPath (MSI requirement) -->
        <!-- Why the registry entry is needed: http://wix.mindcapers.com/wiki/ICE38 -->
        <RegistryValue Root="HKCU" Key="SOFTWARE\GASI\Open eGovernment"
          Name="installed" Type="integer" Value="1" KeyPath="yes" />

        <!-- shortcuts -->
        <Shortcut Id="UninstallProduct"
          Name="Uninstall OEG Base"
          Target="[System32Folder]msiexec.exe"
          Arguments="/x [ProductCode]"
          Directory="ProgramMenuProductExtrasFolder"
          Description="Uninstalls OEG Base" />
        <Shortcut Id="WebShortcut" Name="Homepage" Description="Jump to the OEG website" Target="[HomePageURL]" />

        <!-- Icon="" IconIndex="0" -->
        <!-- Target="[#BinAboutDialog.exe]" - causes warning, different components -->
        <Shortcut Id="SC_StartMenu_BaseComponents_AboutDialog" WorkingDirectory="INSTALLDIR"
          Name="About Dialog" Description="About Dialog" Advertise='no'
          Target="[INSTALLDIR]/bin/about-dialog.exe" Directory="ProgramMenuProductComponentsFolder" />
        <Shortcut Id="SC_StartMenu_BaseComponents_Builder" WorkingDirectory="INSTALLDIR"
          Name="Builder" Description="Builder" Advertise='no'
          Target="[INSTALLDIR]/bin/builder.exe" Directory="ProgramMenuProductComponentsFolder" />
        <Shortcut Id="SC_StartMenu_BaseComponents_Desktop" WorkingDirectory="INSTALLDIR"
          Name="Desktop" Description="Desktop" Advertise='no'
          Target="[INSTALLDIR]/bin/desktop.exe" Directory="ProgramMenuProductComponentsFolder" />
        <Shortcut Id="SC_StartMenu_BaseComponents_HelpViewer" WorkingDirectory="INSTALLDIR"
          Name="Help Viewer" Description="Help Viewer" Advertise='no'
          Target="[INSTALLDIR]/bin/help-viewer.exe" Directory="ProgramMenuProductComponentsFolder" />
        <Shortcut Id="SC_StartMenu_BaseComponents_ProcessList" WorkingDirectory="INSTALLDIR"
          Name="Process List" Description="Process List" Advertise='no'
          Target="[INSTALLDIR]/bin/process-list.exe" Directory="ProgramMenuProductComponentsFolder" />
        <Shortcut Id="SC_StartMenu_BaseComponents_Settings" WorkingDirectory="INSTALLDIR"
          Name="Settings" Description="Settings" Advertise='no'
          Target="[INSTALLDIR]/bin/settings.exe" Directory="ProgramMenuProductComponentsFolder" />
      </Component>
    </DirectoryRef>

    <Feature Id="Complete" Title="Open E-Government Base"
      Description="Complete package of the Open E-Government Base files"
      Display="expand" AllowAdvertise='no' Absent='disallow' InstallDefault='local'
      TypicalDefault='install' Level="2" ConfigurableDirectory="INSTALLDIR">
      <Feature Id='Binaries' Title='Binaries' Description='Required binary applications and libraries.' Level='4'
       AllowAdvertise='no' Absent='disallow' InstallDefault='local' TypicalDefault='install' Display="expand">
        <ComponentRef Id='BaseComponent' />
        <ComponentRef Id='BaseBinComponent' />
        <!-- ComponentRef Id='HelperLibrary' -->
        <ComponentRef Id="StartMenuComponent" />               <!-- Tell WiX to install the shortcuts -->
      </Feature>

      <Feature Id='Documentation' Title='Documentation' Description='The instruction manuals.'
        AllowAdvertise='no' InstallDefault='local' TypicalDefault='install' Level='500' Absent='allow'>
        <ComponentRef Id='BaseComponent' />
        <ComponentRef Id="BasePluginsComponent" />
        <ComponentRef Id="BasePluginsAccessibleComponent" />
      </Feature>

      <Feature Id='OptionalBinaries' Title='Optional'
        Description='Optional binary files not required for a standard setup.'
        AllowAdvertise='no' InstallDefault='local' TypicalDefault='install' Absent='allow' Level='1000'>
        <ComponentRef Id='BaseComponent' />
        <ComponentRef Id="BasePluginsComponent" />
        <ComponentRef Id="BasePluginsAccessibleComponent" />
        <ComponentRef Id="BasePluginsCodecsComponent" />
        <ComponentRef Id="BasePluginsIconEnginesComponent" />
        <ComponentRef Id="BasePluginsImageFormatsComponent" />
        <ComponentRef Id="BasePluginsSqlDriversComponent" />
      </Feature>
    </Feature>

    <!-- http://www.tramontana.co.hu/wix/lesson2.php -->
    <UIRef Id="WixUI_FeatureTree" />
    <UIRef Id="WixUI_ErrorProgressText" />
  </Product>
</Wix>

